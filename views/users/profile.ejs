<%- include('../partials/header') %>
<%- include('../partials/headercopy') %>

<style>
.error-message {
  color: #dc3545;
  font-size: 14px; 
  margin-top: 5px; 
}
</style>


<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" role="dialog" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resetPasswordModalLabel">Reset Password</h5>
          <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close"> -->
            <!-- <span aria-hidden="true">&times;</span> -->
          </button>
        </div>
        <div class="modal-body">
          <form id = "resetPasswordForm">
            <div class="form-group">
              <label for="currentPassword">Current Password</label>
              <input type="password" class="form-control" id="currentPassword" required>
              <div class="error-message" id = "currentPasswordError"></div>
            </div>
            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input type="password" class="form-control" id="newPassword" required>
              <div class="error-message" id = "newPasswordError"></div>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <input type="password" class="form-control" id="confirmPassword" required>
              <div class="error-message" id = "confirmPasswordError"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="resetPasswordSubmit()">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- add address modal -->
  <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addAddressForm">
            <div class="mb-3">
              <label for="addHouseName" class="form-label">House Name</label>
              <input type="text" class="form-control" id="addHouseName">
              <div id="houseNameError" class="error-message text-danger"></div>
            </div>
            <div class="mb-3">
              <label for="addStreet" class="form-label">Street</label>
              <input type="text" class="form-control" id="addStreet">
              <div id="streetError" class="error-message text-danger"></div>
            </div>
            <div class="mb-3">
              <label for="addCity" class="form-label">City</label>
              <input type="text" class="form-control" id="addCity">
              <div id="cityError" class="error-message text-danger"></div>
            </div>
            <div class="mb-3">
              <label for="addState" class="form-label">State</label>
              <input type="text" class="form-control" id="addState">
              <div id="stateError" class="error-message text-danger"></div>
            </div>
            <div class="mb-3">
              <label for="addCountry" class="form-label">Country</label>
              <input type="text" class="form-control" id="addCountry">
              <div id="countryError" class="error-message text-danger"></div>
            </div>
            <div class="mb-3">
              <label for="addPostalCode" class="form-label">Postal Code</label>
              <input type="text" class="form-control" id="addPostalCode">
              <div id="postalCodeError" class="error-message text-danger"></div>
            </div>
            <div class="mb-3">
              <label for="addPhoneNumber" class="form-label">Phone Number</label>
              <input type="text" class="form-control" id="addPhoneNumber">
              <div id="phoneNoError" class="error-message text-danger"></div>
            </div>
            <div class="mb-3">
              <label for="addType" class="form-label">Address Type</label>
              <select class="form-control" id="addType">
                <option value="">Select Address Type</option>
                <option value="Office">Office</option>
                <option value="Home">Home</option>
                <option value="Other">Other</option>
              </select>
              <div id="addressTypeError" class="error-message text-danger"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="saveNewAddress()">Add Address</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Address Modal -->
<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editAddressForm">
          <input type="hidden" id="editAddressId">
          <div class="mb-3">
            <label for="editHouseName" class="form-label">House Name</label>
            <input type="text" class="form-control" id="editHouseName" required>
          </div>
          <div class="mb-3">
            <label for="editStreet" class="form-label">Street</label>
            <input type="text" class="form-control" id="editStreet" required>
          </div>
          <div class="mb-3">
            <label for="editCity" class="form-label">City</label>
            <input type="text" class="form-control" id="editCity" required>
          </div>
          <div class="mb-3">
            <label for="editState" class="form-label">State</label>
            <input type="text" class="form-control" id="editState" required>
          </div>
          <div class="mb-3">
            <label for="editCountry" class="form-label">Country</label>
            <input type="text" class="form-control" id="editCountry" required>
          </div>
          <div class="mb-3">
            <label for="editPostalCode" class="form-label">Postal Code</label>
            <input type="text" class="form-control" id="editPostalCode" required>
          </div>
          <div class="mb-3">
            <label for="editPhoneNo" class="form-label">Phone Number</label>
            <input type="text" class="form-control" id="editPhoneNo" required>
          </div>
          <div class="mb-3">
            <label for="editType" class="form-label">Address Type</label>
            <select class="form-control" id="editType"  name="editAddressType" required>
              <option value="Home">Home</option>
              <option value="Work">Work</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="updateAddress()">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> Profile
                    <!-- <span></span> Account -->
                </div>
            </div>
        </div>
        <section class="pt-150 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 m-auto">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        <!-- <li class="nav-item">
                                            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false"><i class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                        </li> -->
                                        <li class="nav-item">
                                            <a class="nav-link active" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail" role="tab" aria-controls="account-detail" aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false"><i class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true"><i class="fi-rs-marker mr-10"></i>My Address</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="page-login-register.html"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="tab-content dashboard-content">
                                    <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Your Orders</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>Order</th>
                                                                <th>Date</th>
                                                                <th>Status</th>
                                                                <th>Total</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>#1357</td>
                                                                <td>March 45, 2020</td>
                                                                <td>Processing</td>
                                                                <td>$125.00 for 2 item</td>
                                                                <td><a href="#" class="btn-small d-block">View</a></td>
                                                            </tr>
                                                            <tr>
                                                                <td>#2468</td>
                                                                <td>June 29, 2020</td>
                                                                <td>Completed</td>
                                                                <td>$364.00 for 5 item</td>
                                                                <td><a href="#" class="btn-small d-block">View</a></td>
                                                            </tr>
                                                            <tr>
                                                                <td>#2366</td>
                                                                <td>August 02, 2020</td>
                                                                <td>Completed</td>
                                                                <td>$280.00 for 3 item</td>
                                                                <td><a href="#" class="btn-small d-block">View</a></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Orders tracking</h5>
                                            </div>
                                            <div class="card-body contact-from-area">
                                                <p>To track your order please enter your OrderID in the box below and press "Track" button. This was given to you on your receipt and in the confirmation email you should have received.</p>
                                                <div class="row">
                                                    <div class="col-lg-8">
                                                        <form class="contact-form-style mt-30 mb-50" action="#" method="post">
                                                            <div class="input-style mb-20">
                                                                <label>Order ID</label>
                                                                <input name="order-id" placeholder="Found in your order confirmation email" type="text" class="square">
                                                            </div>
                                                            <div class="input-style mb-20">
                                                                <label>Billing email</label>
                                                                <input name="billing-email" placeholder="Email you used during checkout" type="email" class="square">
                                                            </div>
                                                            <button class="submit submit-auto-width" type="submit">Track</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                        <!-- Add Address button -->
                                        <div class="text-end mb-3">
                                          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">Add Address</button>
                                        </div>
                                      
                                        <div class="row">
                                          <% user.address.forEach(function(add) { %>
                                          <div class="col-lg-6 mt-15">
                                            <div class="card mb-3 mb-lg-0">
                                              <div class="card-header">
                                                <h5 class="mb-0"><%=add.type %> Address</h5>
                                              </div>
                                              <div class="card-body">
                                                <address>
                                                  <%=add.houseName%><br>
                                                  <%=add.street %>,<br>
                                                  <%=add.city%>,<%=add.postalCode%> <br>
                                                  <%=add.phoneNumber%><br>
                                                  <%=add.state%>
                                                </address>
                                                <p><%=add.country %></p>
                                                <!-- Edit button in address card -->
                                                <a type="button" class="btn-small" data-bs-toggle="modal" data-bs-target="#editAddressModal" onclick="populateEditForm('<%=add._id%>', '<%=add.houseName%>', '<%=add.street%>', '<%=add.city%>', '<%=add.state%>', '<%=add.country%>', '<%=add.postalCode%>', '<%=add.phoneNumber%>', '<%=add.type%>')">Edit</a>
                                                <a type="button" class="btn-small ml-15" onclick="confirmDelete('<%=add._id%>')">Delete</a>
                                              </div>
                                            </div>
                                          </div>
                                          <% }); %>
                                        </div>
                                      </div>
                                    <div class="tab-pane fade active show" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
                                        <div class="card">
                                          <div class="card-header">
                                            <h5>Account Details</h5>
                                          </div>
                                          <div class="card-body">
                                            <!-- <p>Already have an account? <a href="page-login-register.html">Log in instead!</a></p> -->
                                            <form id="editform">
                                                <div class="row">
                                                  <div class="form-group col-md-6">
                                                    <label>Name <span class="required"></span></label>
                                                    <input required="" class="form-control square" id="name" name="name" type="text" value="<%=user.name%>">
                                                  </div>
                                                  <div class="form-group col-md-6">
                                                    <label>Email Address <span class="required">*</span></label>
                                                    <input required="" class="form-control square" id="email" name="email" type="email" value="<%=user.email %>">
                                                  </div>
                                                  <div class="col-md-12">
                                                    <button type="button" class="btn btn-fill-out submit" name="submit"  onclick="saveUser()">Save</button>
                                                  </div>
                                                </div>
                                              </form>
                                          </div>
                                        </div>
                                        <div class="col-md-12 text-center mt-30">
                                            <button type="button" class="btn btn-fill-out" onclick="resetPassword()">Reset Password</button>
                                          </div>
                                      </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

   <script>
  function saveUser() {
    console.log('changing user details');

    var name = document.getElementById('name').value;
    var email = document.getElementById('email').value;
     console.log(name);
    fetch('/edit-detail', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name,
        email
      })
    })
    .then(response => {
      console.log(`response : ${response}`)
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        console.log("SWEET ALERT");
        Swal.fire({
          icon: 'success',
          title: 'Updated successfully',
          showConfirmButton: true,
          timer: 1500
        }).then(() => {
          window.location.reload()
        });
      } else {
        throw new Error('Update failed');
      }
    })
    .catch(error => {
      console.error('There was a problem with the fetch operation:', error);
      Swal.fire({
        icon: 'error',
        title: 'Update failed',
        text: error.message,
      });
    });
  }
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function resetPassword() {
        let resetPasswordModal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
        resetPasswordModal.show();
    }
function resetPasswordSubmit() {
    // Reset previous error messages
    document.querySelectorAll('.error-message').forEach(elem => elem.textContent = '');

    // Get input values
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    let isValid = true;

    // Validation for empty fields
    if (currentPassword.trim() === '') {
        document.getElementById('currentPasswordError').textContent = 'Current password is required';
        isValid = false;
    }
    if (newPassword.trim() === '') {
        document.getElementById('newPasswordError').textContent = 'New password is required';
        isValid = false;
    } else if (!isStrongPassword(newPassword)) {
        document.getElementById('newPasswordError').textContent = 'Password must contain at least one uppercase letter, one lowercase letter, and one number';
        isValid = false;
    }
    if (confirmPassword.trim() === '') {
        document.getElementById('confirmPasswordError').textContent = 'Confirm password is required';
        isValid = false;
    } else if (newPassword !== confirmPassword) {
        document.getElementById('confirmPasswordError').textContent = 'Passwords do not match';
        isValid = false;
    }
    if (isValid) {
        confirmResetPassword();
    }
}

function isStrongPassword(password) {
    const uppercaseRegex = /[A-Z]/;
    const lowercaseRegex = /[a-z]/;
    const numberRegex = /[0-9]/;
    return uppercaseRegex.test(password) && lowercaseRegex.test(password) && numberRegex.test(password);
}

function confirmResetPassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;

    const data = {
        currentPassword,
        newPassword
    };

    fetch('/reset-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json(); // Parse response body as JSON
    })
    .then(data => {
        // Handle success response from the backend
        if(data.success){
            Swal.fire({
                icon: 'success',
                title: 'Password reset successful',
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                // Hide the modal after the SweetAlert
                let resetPasswordModal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                resetPasswordModal.hide();
                document.getElementById('resetPasswordForm').reset();
            });
        } else {
            // Handle other response errors here
            Swal.fire({
                icon: 'error',
                title: 'Password reset failed',
                text: data.message || 'Unknown error occurred'
            }).then(() => {
                // Hide the modal after the SweetAlert
                let resetPasswordModal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                resetPasswordModal.hide();
                document.getElementById('resetPasswordForm').reset();
            });
        }
    })
    .catch(error => {
        // Handle error
        console.error('There was a problem with the fetch operation:', error);
        Swal.fire({
            icon: 'error',
            title: 'Password reset failed',
            text: error.message
        }).then(() => {
            // Hide the modal after the SweetAlert
            let resetPasswordModal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
            resetPasswordModal.hide();
            document.getElementById('resetPasswordForm').reset();
        });
    });
}
 </script>



<script>
  function saveNewAddress() {
    document.querySelectorAll('.error-message').forEach(elem => elem.textContent = '');

    const houseName = document.getElementById('addHouseName').value.trim();
    const street = document.getElementById('addStreet').value.trim();
    const city = document.getElementById('addCity').value.trim();
    const state = document.getElementById('addState').value.trim();
    const country = document.getElementById('addCountry').value.trim();
    const postalCode = document.getElementById('addPostalCode').value.trim();
    const phoneNumber = document.getElementById('addPhoneNumber').value.trim();
    const addressType = document.getElementById('addType').value;

    let isValid = true;
    if (houseName === '') {
        document.getElementById('houseNameError').textContent = 'House Name is required';
        isValid = false;
    }

    if (street === '') {
        document.getElementById('streetError').textContent = 'Street is required';
        isValid = false;
    }

    if (city === '') {
        document.getElementById('cityError').textContent = 'City is required';
        isValid = false;
    }

    if (state === '') {
        document.getElementById('stateError').textContent = 'State is required';
        isValid = false;
    }

    if (country === '') {
        document.getElementById('countryError').textContent = 'Country is required';
        isValid = false;
    }
    if (!/^\d{6}$/.test(postalCode)) {
        document.getElementById('postalCodeError').textContent = 'Postal Code should contain 6 digits';
        isValid = false;
    }
    if (!/^\d{10}$/.test(phoneNumber)) {
        document.getElementById('phoneNoError').textContent = 'Phone Number should contain 10 digits';
        isValid = false;
    }
    if (addressType === '') {
        document.getElementById('addressTypeError').textContent = 'Please select Address Type';
        isValid = false;
    }

    if (isValid) {
        const data = {
            houseName,
            street,
            city,
            state,
            country,
            postalCode,
            phoneNumber,
            addressType
        };
        fetch('/add-address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if(data.success){
                Swal.fire({
                    icon: 'success',
                    title: 'Address Added Successfully',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    $('#addAddressModal').modal('hide');
                    document.getElementById('addAddressForm').reset();
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Adding Address failed',
                    text: data.message || 'Unknown error occurred'
                }).then(() => {
                    $('#addAddressModal').modal('hide');
                    document.getElementById('addAddressForm').reset();
                    location.reload();
                });
            }
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });
    }
  }
</script>

<script>
  function populateEditForm(addressId, houseName, street, city, state, country, postalCode, phoneNumber, type) {
  document.getElementById('editAddressId').value = addressId;
  document.getElementById('editHouseName').value = houseName;
  document.getElementById('editStreet').value = street;
  document.getElementById('editCity').value = city;
  document.getElementById('editState').value = state;
  document.getElementById('editCountry').value = country;
  document.getElementById('editPostalCode').value = postalCode;
  document.getElementById('editPhoneNo').value = phoneNumber;
  document.getElementById("editType").value = type;
}

function updateAddress() {
  const addressId = document.getElementById('editAddressId').value;
  const houseName = document.getElementById('editHouseName').value;
  const street = document.getElementById('editStreet').value;
  const city = document.getElementById('editCity').value;
  const state = document.getElementById('editState').value;
  const country = document.getElementById('editCountry').value;
  const postalCode = document.getElementById('editPostalCode').value;
  const phoneNumber = document.getElementById('editPhoneNo').value;
  const addressType = document.getElementById("editType").value;

  const data = {
    addressId,
    houseName,
    street,
    city,
    state,
    country,
    postalCode,
    phoneNumber,
    addressType
  };
  console.log(data);

  fetch('/edit-address', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Address Updated'
      }).then(() => {
        $('#editAddressModal').modal('hide');
        document.getElementById('editAddressForm').reset();
        location.reload()
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to update address'
      });
    }
  })
  .catch(error => {
    console.error('Error:', error);
  });
}

  function confirmDelete(addressId) {
  Swal.fire({
    title: 'Are you sure?',
    text: 'Are you sure about deleting the address?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, delete it!',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/delete-address?id=${addressId}`, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('Deleted!', 'The address has been deleted.', 'success').then(() => {
            location.reload();
          });
        } else {
          Swal.fire('Error!', 'Failed to delete the address.', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error!', 'An error occurred while deleting the address.', 'error');
      });
    }
  });
}
</script>



<%- include('../partials/footercopy') %>
<%- include('../partials/footer') %>